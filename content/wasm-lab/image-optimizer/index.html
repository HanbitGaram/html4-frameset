<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>한빛 이미지 경량화 시스템</title>
    <script
      onerror="changeAdsenseToNaverAd()"
      async
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9527582522912841"
      crossorigin="anonymous"
    ></script>
    <style>
      * {
        word-break: break-all;
      }
      :root {
        --border: #e5e7eb;
        --muted: #6b7280;
        --bg: #f9fafb;
        --fg: #111827;
        --accent: #10b981;
        --warn: #f59e0b;
      }
      body {
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          sans-serif;
        margin: 24px;
        color: var(--fg);
      }
      .wrap {
        max-width: 980px;
        margin: 0 auto;
        display: grid;
        gap: 16px;
      }
      .card {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        background: white;
      }
      .grid {
        display: grid;
        gap: 16px;
      }
      @media (min-width: 900px) {
        .grid.cols2 {
          grid-template-columns: 1fr 1fr;
        }
      }
      .label {
        font-size: 12px;
        color: var(--muted);
      }
      .btn {
        padding: 10px 14px;
        border-radius: 10px;
        border: 0;
        background: var(--fg);
        color: white;
        cursor: pointer;
      }
      .btn.alt {
        background: var(--accent);
      }
      .btn.warn {
        background: var(--warn);
      }
      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .muted {
        color: var(--muted);
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      }
      .drop {
        border: 2px dashed var(--border);
        border-radius: 12px;
        background: var(--bg);
        padding: 28px;
        text-align: center;
        cursor: pointer;
        transition: 0.15s border-color ease;
      }
      .drop.dragover {
        border-color: var(--accent);
      }
      img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        background: var(--bg);
      }
      .bar {
        height: 8px;
        background: var(--border);
        border-radius: 9999px;
        position: relative;
        overflow: hidden;
      }
      .bar > span {
        position: absolute;
        inset: 0;
        width: 0;
        background: var(--accent);
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        text-align: left;
        padding: 8px 6px;
        border-bottom: 1px solid var(--border);
        font-size: 14px;
        vertical-align: middle;
      }
      th {
        color: var(--muted);
        font-weight: 600;
      }
      .status {
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 9999px;
        display: inline-block;
      }
      .status.q {
        background: #f3f4f6;
        color: #374151;
      } /* queued */
      .status.p {
        background: #e0f2fe;
        color: #075985;
      } /* processing */
      .status.d {
        background: #dcfce7;
        color: #065f46;
      } /* done */
      .status.e {
        background: #fee2e2;
        color: #991b1b;
      } /* error */

      .spinner {
        width: 14px;
        height: 14px;
        border: 2px solid #d1d5db;
        border-top-color: #4b5563;
        border-radius: 50%;
        display: inline-block;
        animation: spin 0.8s linear infinite;
        vertical-align: -2px;
        margin-right: 6px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .row-actions {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        align-items: center;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <h1>한빛 이미지 경량화 시스템</h1>
        <p class="muted">
          JPG, PNG, WEBP 지원<br />
          파일 두개 이상은 알아서 압축 후 다운로드 가능합니다.<br />
          서버에 파일이 업로드되지 않고 브라우저 내에서만 처리됩니다. 안전하게
          사용하세요.
        </p>
      </header>

      <section class="card grid cols2">
        <div>
          <div class="label">원본 이미지</div>
          <div id="drop" class="drop">
            <strong>여기를 클릭하거나 파일을 드래그 앤 드롭</strong><br />
            <span class="muted" style="font-size: 12px"
              >PNG, JPG, WebP, GIF 지원 · 여러 개 선택 가능</span
            >
          </div>
          <input
            id="file"
            type="file"
            accept="image/png,image/jpeg,image/webp,image/gif"
            multiple
            style="display: none"
          />
          <div id="fileInfo" class="muted mono" style="margin-top: 8px"></div>
        </div>

        <div>
          <div class="label">출력 포맷 · 품질</div>
          <div
            style="
              display: flex;
              gap: 10px;
              flex-wrap: wrap;
              align-items: center;
              margin-top: 6px;
            "
          >
            <select id="format">
              <option value="jpeg">JPEG (.jpg)</option>
              <option value="png">PNG (.png)</option>
              <option value="webp">WebP (.webp)</option>
            </select>
            <div>
              <div class="label" id="qlabel">
                품질: <span id="qval">80</span>
              </div>
              <input
                id="quality"
                type="range"
                min="1"
                max="100"
                value="80"
                style="width: 260px"
              />
            </div>
            <button id="run" class="btn" disabled>변환하기</button>
            <a
              id="downloadAll"
              class="btn alt"
              style="text-decoration: none; display: none"
              >모두 다운로드 (ZIP)</a
            >
          </div>
          <div class="muted" style="font-size: 12px; margin-top: 6px">
            JPEG/WebP: 낮을수록 용량↓ 품질↓ · PNG: 낮을수록 압축↑(느림) 용량↓
          </div>

          <div
            id="globalStatus"
            class="muted mono"
            style="margin-top: 10px"
          ></div>
          <div class="bar" aria-hidden="true" style="margin-top: 6px">
            <span id="globalProg"></span>
          </div>
        </div>
      </section>

      <section class="card grid cols2">
        <div>
          <div class="label">미리보기(첫 번째 파일)</div>
          <img id="previewIn" alt="원본 미리보기" style="display: none" />
          <div class="muted mono" id="infoIn"></div>
        </div>
        <div>
          <div class="label">미리보기(첫 번째 결과)</div>
          <img id="previewOut" alt="결과 미리보기" style="display: none" />
          <div class="muted mono" id="infoOut"></div>
          <div style="margin-top: 12px">
            <div class="label">절감율(첫 파일)</div>
            <div class="bar"><span id="savebar"></span></div>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="label" style="margin-bottom: 6px">결과 목록</div>
        <table>
          <thead>
            <tr>
              <th style="width: 34%">파일명</th>
              <th>상태</th>
              <th>입력 크기</th>
              <th>출력 크기</th>
              <th>절감율</th>
              <th>다운로드</th>
            </tr>
          </thead>
          <tbody id="resultBody"></tbody>
        </table>
      </section>

      <div style="background: #333">
        <ins
          class="adsbygoogle"
          style="margin: 10px 0; display: block"
          data-ad-client="ca-pub-9527582522912841"
          data-ad-slot="3825649038"
          data-ad-format="auto"
          data-full-width-responsive="true"
          data-ad-type="inventory"
          data-ad-adfit-unit="DAN-nRFiQiN4avFYIKbk"
        ></ins>

        <script id="adsense_script">
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
        <script>
          if (window.observeAdsenseUnfilledState !== undefined) {
            observeAdsenseUnfilledState();
          }
        </script>
      </div>
    </div>

    <!-- Go 런타임 -->
    <script src="../wasm_exec.js"></script>
    <!-- ZIP -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

    <script>
      // ---------- 도우미 ----------
      const $ = (s) => document.querySelector(s);
      const fmtSize = (n) =>
        n < 1024
          ? `${n} B`
          : n < 1024 * 1024
          ? `${(n / 1024).toFixed(1)} KB`
          : `${(n / 1024 / 1024).toFixed(2)} MB`;
      const withExt = (name, ext) =>
        (name.replace(/\.[^.]+$/, "") || "image") + "." + ext;

      // ---------- 요소 ----------
      const $file = $("#file"),
        $drop = $("#drop"),
        $fileInfo = $("#fileInfo");
      const $format = $("#format"),
        $quality = $("#quality"),
        $qval = $("#qval");
      const $run = $("#run"),
        $downloadAll = $("#downloadAll");
      const $previewIn = $("#previewIn"),
        $infoIn = $("#infoIn");
      const $previewOut = $("#previewOut"),
        $infoOut = $("#infoOut"),
        $savebar = $("#savebar");
      const $resultBody = $("#resultBody");
      const $globalStatus = $("#globalStatus"),
        $globalProg = $("#globalProg");

      // ---------- 상태 ----------
      let selectedFiles = [];
      let outPreviewURL = null;
      let allZipURL = null;
      let perFileURLs = new Map(); // name -> objectURL

      // ---------- WASM ----------
      const go = new Go();
      let wasmLoaded = false;
      (async function loadWasm() {
        try {
          if ("instantiateStreaming" in WebAssembly) {
            const res = await WebAssembly.instantiateStreaming(
              fetch("./optimizer.wasm"),
              go.importObject
            );
            go.run(res.instance);
          } else {
            const buf = await (await fetch("./optimizer.wasm")).arrayBuffer();
            const res = await WebAssembly.instantiate(buf, go.importObject);
            go.run(res.instance);
          }
          wasmLoaded = true;
          updateRunBtn();
        } catch (e) {
          console.error(e);
          alert("WASM 로드 실패: " + e.message);
        }
      })();

      function updateRunBtn() {
        $previewIn.style.display = selectedFiles.length ? "block" : "none";
        $previewOut.style.display = "block";
        $run.disabled = !(
          wasmLoaded &&
          selectedFiles.length &&
          typeof wasmConvertTo === "function" &&
          typeof wasmDecodeRGBA === "function"
        );
      }

      // ---------- 드래그&드롭 ----------
      ["dragenter", "dragover", "dragleave", "drop"].forEach((ev) => {
        window.addEventListener(
          ev,
          (e) => {
            e.preventDefault();
            e.stopPropagation();
          },
          false
        );
      });
      $drop.addEventListener("click", () => $file.click());
      $drop.addEventListener("dragover", () => $drop.classList.add("dragover"));
      $drop.addEventListener("dragleave", () =>
        $drop.classList.remove("dragover")
      );
      $drop.addEventListener("drop", (e) => {
        $drop.classList.remove("dragover");
        const files = Array.from(e.dataTransfer.files || []);
        if (files.length) setSelectedFiles(files);
      });
      $file.addEventListener("change", () =>
        setSelectedFiles(Array.from($file.files || []))
      );

      function resetURLs() {
        if (outPreviewURL) {
          URL.revokeObjectURL(outPreviewURL);
          outPreviewURL = null;
        }
        if (allZipURL) {
          URL.revokeObjectURL(allZipURL);
          allZipURL = null;
        }
        perFileURLs.forEach((u) => URL.revokeObjectURL(u));
        perFileURLs.clear();
      }

      function setSelectedFiles(files) {
        resetURLs();
        selectedFiles = files.filter((f) => /^image\//.test(f.type));
        $fileInfo.textContent = selectedFiles.length
          ? `${selectedFiles.length}개 선택됨 · 총 ${fmtSize(
              selectedFiles.reduce((s, f) => s + f.size, 0)
            )}`
          : "선택된 파일 없음";
        updateRunBtn();

        // 미리보기(첫 파일)
        if (selectedFiles.length) {
          $previewIn?.src && URL.revokeObjectURL($previewIn.src);
          $previewIn.src = URL.createObjectURL(selectedFiles[0]);
          $infoIn.textContent = `${selectedFiles[0].name} • ${
            selectedFiles[0].type || "unknown"
          } • ${fmtSize(selectedFiles[0].size)}`;
        } else {
          $previewIn?.src && URL.revokeObjectURL($previewIn.src);
          $previewIn.removeAttribute("src");
          $infoIn.textContent = "";
        }

        // 결과/상태 초기화
        $previewOut?.src && URL.revokeObjectURL($previewOut.src);
        $previewOut.removeAttribute("src");
        $infoOut.textContent = "";
        $savebar.style.width = 0;
        $downloadAll.style.display = "none";
        $resultBody.innerHTML = "";
        $globalStatus.textContent = "";
        $globalProg.style.width = "0%";

        runOptimize();
      }

      $quality.addEventListener(
        "input",
        () => ($qval.textContent = $quality.value)
      );

      // ---------- 결과 테이블 행 관리 ----------
      function makeRow(id, name, inSize) {
        const tr = document.createElement("tr");
        tr.id = id;
        tr.innerHTML = `
          <td class="mono">${name}</td>
          <td><span class="status q" data-role="status"><span class="spinner" style="display:none"></span><span data-role="statustext">대기중</span></span></td>
          <td data-role="insize">${fmtSize(inSize)}</td>
          <td data-role="outsize">-</td>
          <td data-role="saved">-</td>
          <td class="row-actions">
            <a class="btn" data-role="download" style="display:none; text-decoration:none;">다운로드</a>
          </td>
        `;
        $resultBody.appendChild(tr);
        return tr;
      }
      function setStatus(tr, type, text, spinning) {
        const badge = tr.querySelector('[data-role="status"]');
        const stext = tr.querySelector('[data-role="statustext"]');
        const spin = tr.querySelector(".spinner");
        badge.className =
          "status " +
          (type === "p" ? "p" : type === "d" ? "d" : type === "e" ? "e" : "q");
        stext.textContent = text;
        spin.style.display = spinning ? "inline-block" : "none";
      }
      function fillResult(tr, outSize, savedPct, url, outName) {
        tr.querySelector('[data-role="outsize"]').textContent =
          fmtSize(outSize);
        tr.querySelector(
          '[data-role="saved"]'
        ).textContent = `${savedPct.toFixed(1)}%`;
        const a = tr.querySelector('[data-role="download"]');
        a.href = url;
        a.download = outName;
        a.style.display = "inline-block";
      }

      $run.addEventListener("click", async () => {
        await runOptimize();
      });

      // ---------- 변환 ----------
      //   $run.addEventListener("click", async () => {
      async function runOptimize() {
        if (!wasmLoaded || !selectedFiles.length) return;
        updateRunBtn();
        $run.disabled = true;
        $downloadAll.style.display = "none";
        $globalStatus.textContent = `대기중…`;
        $globalProg.style.width = "0%";

        // 미리보기 초기화
        $previewOut?.src && URL.revokeObjectURL($previewOut.src);
        $previewOut.removeAttribute("src");
        $infoOut.textContent = "";
        $savebar.style.width = 0;

        // 결과 URL 초기화
        resetURLs();

        const target = $format.value;
        const q = parseInt($quality.value, 10);
        const outputs = []; // {name, blob}

        // 먼저 모든 행을 "대기"로 만들어 두되, 변환 시작 시 상태 갱신/완료 시 즉시 반영
        $resultBody.innerHTML = "";
        selectedFiles.forEach((f, idx) => {
          makeRow(`row-${idx}`, f.name, f.size);
        });

        for (let i = 0; i < selectedFiles.length; i++) {
          const f = selectedFiles[i];
          const row = document.getElementById(`row-${i}`);

          // 글로벌 진행 텍스트/프로그레스
          $globalStatus.innerHTML = `<span class="spinner"></span> 변환 중 ${
            i + 1
          }/${selectedFiles.length} · ${f.name}`;
          const prog = Math.round((i / selectedFiles.length) * 100);
          $globalProg.style.width = `${prog}%`;

          // 행 상태 "처리중"
          setStatus(row, "p", "처리중", true);

          try {
            const inputBytes = new Uint8Array(await f.arrayBuffer());
            let outBlob, mime, outName;

            if (target === "webp") {
              const dec = wasmDecodeRGBA(inputBytes);
              if (!dec.ok) throw new Error(dec.error);
              const w = dec.width,
                h = dec.height;
              const rgba = new Uint8ClampedArray(dec.data);
              const canvas = document.createElement("canvas");
              canvas.width = w;
              canvas.height = h;
              const ctx = canvas.getContext("2d");
              const id = new ImageData(rgba, w, h);
              ctx.putImageData(id, 0, 0);
              const qf = Math.max(0.01, Math.min(1, q / 100));
              outBlob = await new Promise((res) =>
                canvas.toBlob(res, "image/webp", qf)
              );
              mime = "image/webp";
              outName = withExt(f.name, "webp");
            } else {
              const res = wasmConvertTo(inputBytes, target, q);
              if (!res.ok) throw new Error(res.error);
              mime = res.mime;
              outBlob = new Blob([res.data], { type: mime });
              outName = withExt(f.name, target === "jpeg" ? "jpg" : "png");
            }

            outputs.push({ name: outName, blob: outBlob, mime });
            // per-file objectURL + 행 업데이트
            const url = URL.createObjectURL(outBlob);
            perFileURLs.set(outName, url);

            const saved = f.size > 0 ? (1 - outBlob.size / f.size) * 100 : 0;
            fillResult(row, outBlob.size, saved, url, outName);
            setStatus(row, "d", "완료", false);

            // 첫 번째 파일 완료 시 우측 미리보기 갱신
            if (i === 0) {
              outPreviewURL && URL.revokeObjectURL(outPreviewURL);
              outPreviewURL = url;
              $previewOut.src = outPreviewURL;
              $infoOut.textContent = `${mime} • ${fmtSize(
                outBlob.size
              )} • 절감율 ${saved.toFixed(1)}%`;
              $savebar.style.width = `${Math.max(0, Math.min(100, saved))}%`;
            }
          } catch (e) {
            console.error(e);
            const errBlob = new Blob([String(e?.message || e)], {
              type: "text/plain",
            });
            const errName = f.name + ".error.txt";
            outputs.push({ name: errName, blob: errBlob, mime: "text/plain" });

            const url = URL.createObjectURL(errBlob);
            perFileURLs.set(errName, url);

            fillResult(row, 0, 0, url, errName);
            setStatus(row, "e", "오류", false);
          }
        }

        // 마지막 글로벌 상태/프로그레스 100%
        $globalStatus.textContent = `완료 ${selectedFiles.length}/${selectedFiles.length}`;
        $globalProg.style.width = "100%";

        // ZIP (2개 이상일 때 노출) — 개별 다운로드는 각 행에서 가능
        if (outputs.length > 1) {
          const zip = new JSZip();
          const folder = zip.folder("converted") || zip;
          for (const o of outputs) folder.file(o.name, o.blob);
          const zipBlob = await zip.generateAsync({
            type: "blob",
            compression: "DEFLATE",
          });
          allZipURL && URL.revokeObjectURL(allZipURL);
          allZipURL = URL.createObjectURL(zipBlob);
          const zipName = `converted_${Date.now()}.zip`;
          $downloadAll.href = allZipURL;
          $downloadAll.download = zipName;
          $downloadAll.style.display = "inline-block";
          $downloadAll.textContent = `모두 다운로드 (ZIP: ${zipName})`;
        } else {
          $downloadAll.style.display = "none";
        }

        $run.disabled = false;
        // });
      }
    </script>
  </body>
</html>
